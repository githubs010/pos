<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Glass POS System - Pro</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- jsPDF & AutoTable for PDF Generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
    
    <style>
        body { 
            font-family: 'Inter', sans-serif; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        /* Glassmorphism Utilities */
        .glass {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
        }
        
        .glass-dark {
            background: rgba(17, 24, 39, 0.7);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-right: 1px solid rgba(255, 255, 255, 0.1);
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.6);
            backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 255, 255, 0.4);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.05);
        }

        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-in { animation: fadeIn 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards; }

        /* PRINT STYLES - FIXED FOR BLANK PAGE ISSUE */
        @media print {
            /* Reset Page */
            @page { margin: 0; size: auto; }
            body, html { 
                background: white !important; 
                height: 100% !important; 
                width: 100% !important;
                overflow: visible !important;
            }

            /* Hide the Main App Interface */
            #main-interface { 
                display: none !important; 
            }

            /* Reset the Modal Wrapper to be the Print Container */
            .fixed.inset-0 {
                position: static !important;
                display: block !important;
                background: white !important;
                width: 100% !important;
                height: auto !important;
                z-index: 9999 !important;
                padding: 0 !important;
                margin: 0 !important;
            }

            /* Reset Glass Effect for Print */
            .glass, .glass-card {
                background: none !important;
                border: none !important;
                box-shadow: none !important;
                backdrop-filter: none !important;
                position: static !important;
                padding: 0 !important;
                margin: 0 !important;
            }

            /* Hide Header and Footer of Modal */
            .glass > .flex.justify-between, /* The modal header row */
            .no-print { /* The buttons at bottom */
                display: none !important;
            }

            /* Ensure Modal Content Area allows overflow */
            .p-5.max-h-\[80vh\] {
                max-height: none !important;
                overflow: visible !important;
                padding: 0 !important;
            }

            /* Style the Receipt specifically */
            #receipt-printable {
                display: block !important;
                visibility: visible !important;
                width: 80mm !important; /* Force Thermal Width */
                max-width: 100% !important;
                margin: 0 !important;
                padding: 10px !important;
                border: none !important;
                box-shadow: none !important;
                color: black !important;
                font-family: monospace !important;
            }
            
            /* Force text color black */
            * { color: black !important; text-shadow: none !important; }
        }
    </style>
</head>
<body class="text-slate-800 antialiased selection:bg-indigo-500 selection:text-white">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        // --- ICONS ---
        const Icon = ({ path, size = 20, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{path}</svg>
        );
        const Icons = {
            Dashboard: (p) => <Icon {...p} path={<><rect width="7" height="9" x="3" y="3" rx="1"/><rect width="7" height="5" x="14" y="3" rx="1"/><rect width="7" height="9" x="14" y="12" rx="1"/><rect width="7" height="5" x="3" y="16" rx="1"/></>} />,
            Cart: (p) => <Icon {...p} path={<><circle cx="8" cy="21" r="1"/><circle cx="19" cy="21" r="1"/><path d="M2.05 2.05h2l2.66 12.42a2 2 0 0 0 2 1.58h9.78a2 2 0 0 0 1.95-1.57l1.65-7.43H5.12"/></>} />,
            Box: (p) => <Icon {...p} path={<><path d="m16.5 9.4-9-5.19"/><path d="m21 16-9 5.19-9-5.19"/><path d="M3 11.05v6.25c0 1.66.57 3.2 1.63 4.39"/><path d="M12 22V10.8"/><path d="M12 2.76c.49-.28 1.5-.28 2 0l7.37 4.26c.86.5 1.63 1.25 1.63 2.78v5.4"/><path d="M21 15.2v-4.4"/><path d="M12 2.76 4.63 7.02c-.86.5-1.63 1.25-1.63 2.78v.2"/></>} />,
            Users: (p) => <Icon {...p} path={<><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></>} />,
            Report: (p) => <Icon {...p} path={<><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><line x1="16" x2="8" y1="13" y2="13"/><line x1="16" x2="8" y1="17" y2="17"/><line x1="10" x2="8" y1="9" y2="9"/></>} />,
            Settings: (p) => <Icon {...p} path={<><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.1a2 2 0 0 1-1-1.72v-.51a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></>} />,
            Logout: (p) => <Icon {...p} path={<><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" x2="9" y1="12" y2="12"/></>} />,
            Plus: (p) => <Icon {...p} path={<><path d="M5 12h14"/><path d="M12 5v14"/></>} />,
            Minus: (p) => <Icon {...p} path={<><path d="M5 12h14"/></>} />,
            Trash: (p) => <Icon {...p} path={<><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></>} />,
            Search: (p) => <Icon {...p} path={<><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></>} />,
            X: (p) => <Icon {...p} path={<><path d="M18 6 6 18"/><path d="m6 6 12 12"/></>} />,
            Printer: (p) => <Icon {...p} path={<><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect width="12" height="8" x="6" y="14"/></>} />,
            Download: (p) => <Icon {...p} path={<><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></>} />,
            Github: (p) => <Icon {...p} path={<><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path></>} />,
            CloudCheck: (p) => <Icon {...p} path={<><path d="M12 21a6 6 0 0 0 6-6c0-3.3-2.7-6-6-6-.8 0-1.5.1-2.2.3A7.5 7.5 0 0 0 0 12.5a7.5 7.5 0 0 0 7.5 7.5h4.5"/><polyline points="16 12 18 14 22 10"/></>} />,
            CloudOff: (p) => <Icon {...p} path={<><path d="M22.61 16.95A5 5 0 0 0 18 10h-1.26a8 8 0 0 0-7.05-6M5 5a8 8 0 0 0 4 15h9a5 5 0 0 0 1.7-.3"/><line x1="1" x2="23" y1="1" y2="23"/></>} />,
            UserPlus: (p) => <Icon {...p} path={<><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="8.5" cy="7" r="4"/><line x1="20" y1="8" x2="20" y2="14"/><line x1="23" y1="11" x2="17" y2="11"/></>} />,
            TrendingUp: (p) => <Icon {...p} path={<><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/></>} />,
            TrendingDown: (p) => <Icon {...p} path={<><polyline points="23 18 13.5 8.5 8.5 13.5 1 6"/><polyline points="17 18 23 18 23 12"/></>} />,
            Refresh: (p) => <Icon {...p} path={<><path d="M23 4v6h-6"/><path d="M1 20v-6h6"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></>} />,
            FileText: (p) => <Icon {...p} path={<><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></>} />,
        };

        // --- COMPONENTS ---
        const Card = ({ children, className = "" }) => <div className={`glass-card rounded-2xl p-6 ${className}`}>{children}</div>;
        
        const Button = ({ children, onClick, variant = "primary", className = "", disabled=false, ...props }) => {
            const styles = {
                primary: "bg-indigo-600 text-white hover:bg-indigo-700 shadow-lg shadow-indigo-500/30 border-transparent",
                secondary: "bg-white/50 text-slate-700 hover:bg-white border-white/40",
                danger: "bg-red-500 text-white hover:bg-red-600 shadow-lg shadow-red-500/30 border-transparent",
                outline: "border-slate-300 text-slate-600 hover:bg-white/50 bg-transparent",
                success: "bg-emerald-500 text-white hover:bg-emerald-600 shadow-lg shadow-emerald-500/30 border-transparent",
                github: "bg-slate-900 text-white hover:bg-black shadow-lg shadow-black/30"
            };
            return (
                <button onClick={onClick} disabled={disabled} className={`px-4 py-2.5 rounded-xl font-medium transition-all active:scale-95 flex items-center justify-center gap-2 border disabled:opacity-50 disabled:cursor-not-allowed ${styles[variant]} ${className}`} {...props}>{children}</button>
            );
        };

        const Input = ({ label, ...props }) => (
            <div className="mb-4">
                {label && <label className="block text-xs font-bold text-slate-600 uppercase mb-1.5 tracking-wider">{label}</label>}
                <input className="w-full px-4 py-2.5 bg-white/50 border border-slate-200/60 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:bg-white outline-none transition-all placeholder:text-slate-400" {...props} />
            </div>
        );

        const Modal = ({ isOpen, onClose, title, children }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/40 backdrop-blur-md p-4 animate-in">
                    <div className="glass rounded-2xl w-full max-w-md overflow-hidden shadow-2xl">
                        <div className="flex justify-between items-center p-5 border-b border-slate-200/50">
                            <h3 className="font-bold text-xl text-slate-800">{title}</h3>
                            <button onClick={onClose} className="p-2 hover:bg-slate-100/50 rounded-full transition-colors"><Icons.X size={20}/></button>
                        </div>
                        <div className="p-5 max-h-[80vh] overflow-y-auto">{children}</div>
                    </div>
                </div>
            );
        };

        // --- PDF GENERATORS ---
        const generateReceiptPDF = (tx, profile) => {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({
                orientation: 'portrait',
                unit: 'mm',
                format: [80, 200] // Approximate thermal printer width
            });

            let y = 10;
            doc.setFontSize(14);
            doc.setFont(undefined, 'bold');
            doc.text(profile.name || "Business Name", 40, y, { align: 'center' });
            y += 6;
            
            doc.setFontSize(8);
            doc.setFont(undefined, 'normal');
            if(profile.address) { doc.text(profile.address, 40, y, { align: 'center' }); y += 4; }
            if(profile.location) { doc.text(profile.location, 40, y, { align: 'center' }); y += 4; }
            if(profile.phone) { doc.text(`Tel: ${profile.phone}`, 40, y, { align: 'center' }); y += 4; }
            if(profile.gst) { doc.text(`GST No: ${profile.gst}`, 40, y, { align: 'center' }); y += 4; }
            if(profile.type) { doc.text(`(${profile.type})`, 40, y, { align: 'center' }); y += 4; }
            
            doc.text("-".repeat(45), 40, y, { align: 'center' });
            y += 4;

            doc.text(`Date: ${new Date(tx.date).toLocaleDateString()}`, 5, y);
            y += 4;
            doc.text(`Time: ${new Date(tx.date).toLocaleTimeString()}`, 5, y);
            y += 4;
            doc.text(`Bill No: ${tx.id.slice(-6)}`, 5, y);
            y += 5;

            // Headers
            doc.setFont(undefined, 'bold');
            doc.text("Item", 5, y);
            doc.text("Qty", 45, y);
            doc.text("Price", 60, y);
            y += 4;
            doc.setFont(undefined, 'normal');
            
            tx.items.forEach(item => {
                let name = item.name.length > 15 ? item.name.substring(0,15)+"..." : item.name;
                doc.text(name, 5, y);
                doc.text(item.quantity.toString(), 48, y, { align: 'center' });
                doc.text((item.price * item.quantity).toFixed(2), 75, y, { align: 'right' });
                y += 4;
            });

            doc.text("-".repeat(45), 40, y, { align: 'center' });
            y += 4;
            
            doc.setFontSize(12);
            doc.setFont(undefined, 'bold');
            doc.text(`Total: ${tx.total.toFixed(2)}`, 75, y, { align: 'right' });
            
            y += 8;
            doc.setFontSize(8);
            doc.setFont(undefined, 'italic');
            doc.text("Thank you for your business!", 40, y, { align: 'center' });

            doc.save(`Receipt_${tx.id.slice(-6)}.pdf`);
        };

        const generateReportPDF = (data, title, type, profile) => {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Header
            doc.setFontSize(18);
            doc.text(profile.name || "Business Name", 14, 15);
            doc.setFontSize(10);
            if(profile.address) doc.text(profile.address, 14, 20);
            if(profile.gst) doc.text(`GST: ${profile.gst}`, 14, 25);

            doc.setFontSize(14);
            doc.text(title, 14, 35);
            doc.setFontSize(10);
            doc.text(`Generated: ${new Date().toLocaleString()}`, 14, 40);

            let columns = [];
            let body = [];

            if (type === 'sales') {
                columns = ["Date", "Tx ID", "Items", "Cashier", "Total"];
                body = data.map(row => [
                    new Date(row.date).toLocaleDateString() + ' ' + new Date(row.date).toLocaleTimeString(),
                    row.id,
                    row.items.length,
                    row.cashier,
                    row.total.toFixed(2)
                ]);
            } else if (type === 'stockIn' || type === 'stockOut') {
                columns = ["Date", "Type", "Product", "Qty", "Reason"];
                body = data.map(row => [
                    new Date(row.date).toLocaleDateString(),
                    row.type,
                    row.prodName,
                    row.qty,
                    row.reason
                ]);
            }

            doc.autoTable({
                head: [columns],
                body: body,
                startY: 45,
                theme: 'grid',
                headStyles: { fillColor: [79, 70, 229] } // Indigo color
            });

            doc.save(`${type}_report.pdf`);
        };

        // --- GITHUB API ---
        const GITHUB_API_URL = "https://api.github.com";
        const GIST_FILENAME = "pos_data.json";

        const saveToGist = async (token, gistId, data) => {
            const response = await fetch(`${GITHUB_API_URL}/gists/${gistId}`, {
                method: "PATCH",
                headers: { "Authorization": `token ${token}`, "Accept": "application/vnd.github.v3+json" },
                body: JSON.stringify({ files: { [GIST_FILENAME]: { content: JSON.stringify(data) } } })
            });
            if (!response.ok) throw new Error("Save Failed");
            return await response.json();
        };

        const loadFromGist = async (token, gistId) => {
            const response = await fetch(`${GITHUB_API_URL}/gists/${gistId}?t=${Date.now()}`, {
                headers: { "Authorization": `token ${token}`, "Accept": "application/vnd.github.v3+json" }
            });
            if (!response.ok) throw new Error("Load Failed");
            const json = await response.json();
            return json.files && json.files[GIST_FILENAME] ? JSON.parse(json.files[GIST_FILENAME].content) : null;
        };

        const createGist = async (token, description, initialData) => {
            const response = await fetch(`${GITHUB_API_URL}/gists`, {
                method: "POST",
                headers: { "Authorization": `token ${token}`, "Accept": "application/vnd.github.v3+json" },
                body: JSON.stringify({ description, public: false, files: { [GIST_FILENAME]: { content: JSON.stringify(initialData) } } })
            });
            if (!response.ok) throw new Error("Create Failed");
            return await response.json();
        };

        const downloadCSV = (data, filename) => {
            if (!data.length) return alert("No data");
            const headers = Object.keys(data[0]).join(',');
            const rows = data.map(obj => Object.values(obj).map(v => `"${v}"`).join(',')).join('\n');
            const blob = new Blob([headers + '\n' + rows], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = filename; a.click();
        };

        // --- INITIAL DATA STRUCTURE ---
        const DEFAULT_DATA = {
            products: [
                { id: 1, name: "Espresso", price: 150, category: "Coffee", stock: 100 },
                { id: 2, name: "Masala Chai", price: 40, category: "Tea", stock: 200 },
            ],
            users: [
                { id: 1, username: "admin", password: "123", role: "Admin", name: "Super Admin" },
                { id: 2, username: "staff", password: "123", role: "Staff", name: "John Doe" },
            ],
            customers: [],
            sales: [],
            stockLog: [],
            profile: { 
                name: "Glass POS", 
                address: "Cloud City", 
                phone: "555-0101", 
                logo: "", // Placeholder for logo URL
                location: "Main Street", 
                gst: "GSTIN12345", 
                type: "Retail" 
            }
        };

        // --- MAIN APPLICATION ---
        function App() {
            const [view, setView] = useState('login'); 
            const [activeUser, setActiveUser] = useState(null);
            const [ghConfig, setGhConfig] = useState(() => JSON.parse(localStorage.getItem('gh_config')) || { token: '', gistId: '' });
            
            // --- SMART DATA INIT (MIGRATION LOGIC) ---
            const [data, setData] = useState(() => {
                try {
                    const local = JSON.parse(localStorage.getItem('pos_data'));
                    if (!local) return DEFAULT_DATA;
                    
                    let migrated = { ...local };
                    
                    // Migration 1: Users
                    if (!local.users || !Array.isArray(local.users)) {
                        migrated.users = DEFAULT_DATA.users;
                    }
                    // Migration 2: Enhanced Profile
                    if (!local.profile || !local.profile.gst) {
                        migrated.profile = { ...DEFAULT_DATA.profile, ...local.profile };
                    }
                    
                    return migrated;
                } catch (e) {
                    return DEFAULT_DATA;
                }
            });

            const [isOnline, setIsOnline] = useState(false);
            const [isSyncing, setIsSyncing] = useState(false);

            // UI State
            const [cart, setCart] = useState([]);
            const [activeCustomer, setActiveCustomer] = useState(null);
            const [search, setSearch] = useState("");
            const [receiptTx, setReceiptTx] = useState(null);

            // Persist Data
            useEffect(() => { localStorage.setItem('pos_data', JSON.stringify(data)); }, [data]);
            useEffect(() => { 
                localStorage.setItem('gh_config', JSON.stringify(ghConfig));
                if (ghConfig.token && ghConfig.gistId) { setIsOnline(true); syncDataFromCloud(); }
            }, [ghConfig]);

            // --- SYNC FUNCTIONS ---
            const syncDataToCloud = async (newData) => {
                if (!ghConfig.token) return;
                setIsSyncing(true);
                try { await saveToGist(ghConfig.token, ghConfig.gistId, newData || data); } 
                catch (e) { console.error(e); } 
                finally { setIsSyncing(false); }
            };

            const syncDataFromCloud = async () => {
                if (!ghConfig.token) return;
                setIsSyncing(true);
                try {
                    const cloud = await loadFromGist(ghConfig.token, ghConfig.gistId);
                    if (cloud) setData(cloud);
                } catch (e) { console.error(e); } 
                finally { setIsSyncing(false); }
            };

            // --- LOGIC ---
            const updateData = (key, value) => {
                const newData = { ...data, [key]: value };
                setData(newData);
                if (['products', 'sales', 'stockLog', 'users', 'profile'].includes(key)) syncDataToCloud(newData);
            };

            const handleLogin = (username, password) => {
                if(!data.users) {
                    if(username === 'admin' && password === '123') {
                        setData(DEFAULT_DATA); 
                        setActiveUser(DEFAULT_DATA.users[0]);
                        setView('pos');
                        alert("System Reset & Logged In");
                        return;
                    }
                }
                const user = data.users.find(u => u.username === username && u.password === password);
                if (user) {
                    setActiveUser(user);
                    setView('pos');
                } else {
                    alert("Invalid Credentials.");
                }
            };

            const handleRegister = (name, username, password) => {
                if (!name || !username || !password) return alert("Please fill all fields");
                if (data.users && data.users.some(u => u.username === username)) return alert("Username taken");
                
                const newUser = { 
                    id: Date.now(), 
                    name, 
                    username, 
                    password, 
                    role: 'Admin' // First created user via signup is Admin
                };
                
                const currentUsers = data.users || [];
                const newData = { ...data, users: [...currentUsers, newUser] };
                setData(newData);
                syncDataToCloud(newData);
                setActiveUser(newUser);
                setView('pos');
                alert("Account Created & Logged In!");
            };

            const fullReset = () => {
                if(confirm("Warning: This will delete LOCAL data and reset to defaults. Use this if login is broken. Continue?")) {
                    localStorage.clear();
                    setData(DEFAULT_DATA);
                    alert("System Reset. Try logging in with admin / 123");
                }
            };

            const checkout = () => {
                if (cart.length === 0) return;
                const total = cart.reduce((sum, i) => sum + (i.price * i.quantity), 0);
                const tx = {
                    id: Date.now().toString(36).toUpperCase(),
                    date: new Date().toISOString(),
                    items: cart,
                    total,
                    customer: activeCustomer || { name: "Walk-in", id: "walkin" },
                    cashier: activeUser.name
                };

                const newLogs = cart.map(item => ({
                    date: new Date().toISOString(),
                    type: 'OUT',
                    prodName: item.name,
                    qty: item.quantity,
                    reason: `Sale #${tx.id}`
                }));

                const newProducts = data.products.map(p => {
                    const cItem = cart.find(c => c.id === p.id);
                    return cItem ? { ...p, stock: p.stock - cItem.quantity } : p;
                });

                const newData = {
                    ...data,
                    sales: [tx, ...data.sales],
                    products: newProducts,
                    stockLog: [...newLogs, ...data.stockLog]
                };

                setData(newData);
                syncDataToCloud(newData);
                setReceiptTx(tx);
                setCart([]);
            };

            // --- VIEWS ---
            const LoginView = () => {
                const [isRegistering, setIsRegistering] = useState(false);
                const [creds, setCreds] = useState({ name: '', u: '', p: '' });

                return (
                    <div className="min-h-screen flex items-center justify-center p-4">
                        <div className="glass p-8 rounded-3xl w-full max-w-sm text-center shadow-2xl animate-in relative">
                            <div className="w-20 h-20 bg-gradient-to-tr from-indigo-500 to-purple-500 rounded-2xl flex items-center justify-center mx-auto mb-6 shadow-lg shadow-indigo-500/40 text-white">
                                <Icons.Box size={40}/>
                            </div>
                            <h1 className="text-3xl font-bold mb-1 text-slate-800">{data.profile?.name || "POS System"}</h1>
                            <p className="text-slate-500 mb-8 font-medium">{isRegistering ? "Create New Account" : "Secure Login"}</p>
                            
                            {isRegistering && (
                                <Input placeholder="Full Name" value={creds.name} onChange={e => setCreds({...creds, name: e.target.value})} />
                            )}
                            <Input placeholder="Username" value={creds.u} onChange={e => setCreds({...creds, u: e.target.value})} />
                            <Input type="password" placeholder="Password" value={creds.p} onChange={e => setCreds({...creds, p: e.target.value})} />
                            
                            {isRegistering ? (
                                <Button className="w-full py-3 text-lg" onClick={() => handleRegister(creds.name, creds.u, creds.p)}>Sign Up & Login</Button>
                            ) : (
                                <Button className="w-full py-3 text-lg" onClick={() => handleLogin(creds.u, creds.p)}>Login Access</Button>
                            )}
                            
                            <div className="mt-6 text-xs text-slate-500">
                                {isRegistering ? (
                                    <p>Already have an account? <button onClick={() => setIsRegistering(false)} className="text-indigo-600 font-bold hover:underline">Login</button></p>
                                ) : (
                                    <p>New here? <button onClick={() => setIsRegistering(true)} className="text-indigo-600 font-bold hover:underline">Create Account</button></p>
                                )}
                            </div>

                            {!isRegistering && (
                                <button onClick={fullReset} className="mt-6 text-xs text-red-400 hover:text-red-600 flex items-center justify-center gap-1 mx-auto opacity-60 hover:opacity-100 transition-opacity">
                                    <Icons.Refresh size={10}/> Reset System (Fix Login)
                                </button>
                            )}
                        </div>
                    </div>
                );
            };

            const POSView = () => {
                const filtered = data.products.filter(p => p.name.toLowerCase().includes(search.toLowerCase()));
                const total = cart.reduce((sum, i) => sum + (i.price * i.quantity), 0);

                return (
                    <div id="main-interface" className="flex h-full gap-6">
                        <div className="flex-1 flex flex-col">
                            <div className="flex justify-between items-center mb-6">
                                <h2 className="text-2xl font-bold text-slate-800">Point of Sale</h2>
                                <div className="relative">
                                    <input placeholder="Search products..." value={search} onChange={e => setSearch(e.target.value)} 
                                        className="pl-10 pr-4 py-2 rounded-full glass border-none focus:ring-2 focus:ring-indigo-500 outline-none w-64 text-sm" />
                                    <span className="absolute left-3 top-2.5 text-slate-500"><Icons.Search size={16}/></span>
                                </div>
                            </div>
                            <div className="grid grid-cols-2 lg:grid-cols-4 gap-4 overflow-y-auto pb-4 pr-2">
                                {filtered.map(p => (
                                    <div key={p.id} onClick={() => p.stock > 0 && setCart(prev => {
                                        const ex = prev.find(i => i.id === p.id);
                                        return ex ? prev.map(i => i.id === p.id ? {...i, quantity: i.quantity + 1} : i) : [...prev, {...p, quantity: 1}];
                                    })} className={`glass-card p-4 rounded-2xl hover:shadow-xl cursor-pointer transition-all active:scale-95 group ${p.stock === 0 ? 'opacity-50 grayscale' : ''}`}>
                                        <div className="h-24 bg-gradient-to-br from-indigo-50 to-purple-50 rounded-xl mb-3 flex items-center justify-center font-bold text-3xl text-indigo-200 group-hover:text-indigo-400 transition-colors">
                                            {p.name[0]}
                                        </div>
                                        <div className="font-bold text-slate-800 truncate">{p.name}</div>
                                        <div className="flex justify-between mt-1 items-end">
                                            <span className="text-indigo-600 font-bold text-lg">₹{p.price}</span>
                                            <span className={`text-xs font-medium px-2 py-0.5 rounded-full ${p.stock < 10 ? 'bg-red-100 text-red-600' : 'bg-slate-100 text-slate-500'}`}>
                                                {p.stock} left
                                            </span>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                        <div className="w-96 glass-card rounded-2xl flex flex-col h-full overflow-hidden border-0 shadow-2xl">
                            <div className="p-5 bg-white/40 border-b border-white/20">
                                <div className="flex items-center gap-2 mb-3">
                                    <Icons.Cart className="text-indigo-600"/> 
                                    <span className="font-bold text-slate-700">Current Order</span>
                                </div>
                                <select className="w-full p-2 rounded-lg bg-white/50 border-none text-sm outline-none" onChange={e => setActiveCustomer(data.customers.find(c => c.id == e.target.value))}>
                                    <option value="">Walk-in Customer</option>
                                    {data.customers.map(c => <option key={c.id} value={c.id}>{c.name}</option>)}
                                </select>
                            </div>
                            <div className="flex-1 overflow-y-auto p-4 space-y-3">
                                {cart.map(item => (
                                    <div key={item.id} className="flex justify-between items-center bg-white/60 p-3 rounded-xl border border-white/40 shadow-sm animate-in">
                                        <div>
                                            <div className="font-bold text-sm text-slate-800">{item.name}</div>
                                            <div className="text-xs text-slate-500">₹{item.price} x {item.quantity}</div>
                                        </div>
                                        <button onClick={() => setCart(prev => prev.filter(i => i.id !== item.id))} className="text-red-400 hover:text-red-600 p-1"><Icons.Trash size={18}/></button>
                                    </div>
                                ))}
                            </div>
                            <div className="p-5 bg-white/60 border-t border-white/50 backdrop-blur-md">
                                <div className="flex justify-between text-2xl font-bold mb-4 text-slate-800">
                                    <span>Total</span><span>₹{total.toFixed(2)}</span>
                                </div>
                                <Button onClick={checkout} className="w-full py-4 text-lg shadow-indigo-500/40">PAY NOW</Button>
                            </div>
                        </div>
                    </div>
                );
            };

            const ReportsView = () => {
                const [dateRange, setDateRange] = useState({ start: new Date().toISOString().split('T')[0], end: new Date().toISOString().split('T')[0] });
                const [tab, setTab] = useState('sales'); // sales, stockIn, stockOut

                // Filter Logic
                const filterByDate = (items) => items.filter(i => {
                    const d = i.date.split('T')[0];
                    return d >= dateRange.start && d <= dateRange.end;
                });

                const filteredSales = filterByDate(data.sales);
                const filteredStockIn = filterByDate(data.stockLog.filter(l => l.type === 'IN'));
                const filteredStockOut = filterByDate(data.stockLog.filter(l => l.type === 'OUT'));

                return (
                    <div id="main-interface" className="h-full flex flex-col">
                        <div className="flex justify-between items-end mb-6">
                            <div>
                                <h2 className="text-2xl font-bold mb-1">Reports & Analytics</h2>
                                <p className="text-sm text-slate-500">Track performance over time.</p>
                            </div>
                            <div className="flex gap-2 bg-white/40 p-1 rounded-xl">
                                <input type="date" value={dateRange.start} onChange={e => setDateRange({...dateRange, start: e.target.value})} className="bg-transparent border-none text-sm p-2 outline-none"/>
                                <span className="self-center text-slate-400">to</span>
                                <input type="date" value={dateRange.end} onChange={e => setDateRange({...dateRange, end: e.target.value})} className="bg-transparent border-none text-sm p-2 outline-none"/>
                            </div>
                        </div>

                        <div className="grid grid-cols-3 gap-4 mb-6">
                            <Card className="flex items-center gap-4 bg-indigo-500/10 border-indigo-200/50">
                                <div className="p-3 bg-indigo-500 text-white rounded-xl"><Icons.TrendingUp/></div>
                                <div><div className="text-xs font-bold uppercase text-indigo-600">Total Sales</div><div className="text-2xl font-bold text-slate-800">₹{filteredSales.reduce((a,b)=>a+b.total,0)}</div></div>
                            </Card>
                            <Card className="flex items-center gap-4 bg-emerald-500/10 border-emerald-200/50">
                                <div className="p-3 bg-emerald-500 text-white rounded-xl"><Icons.Plus/></div>
                                <div><div className="text-xs font-bold uppercase text-emerald-600">Stock Added</div><div className="text-2xl font-bold text-slate-800">{filteredStockIn.reduce((a,b)=>a+b.qty,0)} units</div></div>
                            </Card>
                            <Card className="flex items-center gap-4 bg-red-500/10 border-red-200/50">
                                <div className="p-3 bg-red-500 text-white rounded-xl"><Icons.Minus/></div>
                                <div><div className="text-xs font-bold uppercase text-red-600">Stock Out</div><div className="text-2xl font-bold text-slate-800">{filteredStockOut.reduce((a,b)=>a+b.qty,0)} units</div></div>
                            </Card>
                        </div>

                        <div className="flex gap-4 mb-4">
                            {['sales', 'stockIn', 'stockOut'].map(t => (
                                <button key={t} onClick={() => setTab(t)} className={`px-4 py-2 rounded-lg text-sm font-bold capitalize transition-all ${tab === t ? 'bg-indigo-600 text-white shadow-lg' : 'bg-white/40 hover:bg-white/60'}`}>
                                    {t.replace(/([A-Z])/g, ' $1')} Report
                                </button>
                            ))}
                            <div className="flex-1"></div>
                            <Button size="sm" variant="secondary" onClick={() => downloadCSV(tab === 'sales' ? filteredSales : tab === 'stockIn' ? filteredStockIn : filteredStockOut, 'report.csv')}><Icons.Download size={16}/> CSV</Button>
                            <Button size="sm" onClick={() => generateReportPDF(tab === 'sales' ? filteredSales : tab === 'stockIn' ? filteredStockIn : filteredStockOut, `${tab} Report`, tab, data.profile)}><Icons.FileText size={16}/> PDF</Button>
                        </div>

                        <div className="flex-1 glass-card rounded-2xl overflow-hidden flex flex-col">
                            <div className="overflow-y-auto flex-1 p-0">
                                <table className="w-full text-left text-sm">
                                    <thead className="bg-white/50 sticky top-0 backdrop-blur-sm z-10">
                                        <tr>
                                            <th className="p-4 font-bold text-slate-600">Date/Time</th>
                                            <th className="p-4 font-bold text-slate-600">{tab === 'sales' ? 'Transaction ID' : 'Product'}</th>
                                            <th className="p-4 font-bold text-slate-600">{tab === 'sales' ? 'Total' : 'Qty'}</th>
                                            <th className="p-4 font-bold text-slate-600">{tab === 'sales' ? 'Cashier' : 'Reason'}</th>
                                        </tr>
                                    </thead>
                                    <tbody className="divide-y divide-white/20">
                                        {(tab === 'sales' ? filteredSales : tab === 'stockIn' ? filteredStockIn : filteredStockOut).map((row, i) => (
                                            <tr key={i} className="hover:bg-white/30 transition-colors">
                                                <td className="p-4 text-slate-500 font-mono text-xs">{new Date(row.date).toLocaleString()}</td>
                                                <td className="p-4 font-medium text-slate-800">{tab === 'sales' ? row.id : row.prodName}</td>
                                                <td className="p-4 font-bold">{tab === 'sales' ? `₹${row.total.toFixed(2)}` : row.qty}</td>
                                                <td className="p-4 text-slate-500">{tab === 'sales' ? row.cashier : row.reason}</td>
                                            </tr>
                                        ))}
                                        {(tab === 'sales' ? filteredSales : tab === 'stockIn' ? filteredStockIn : filteredStockOut).length === 0 && (
                                            <tr><td colSpan="4" className="p-8 text-center text-slate-400 italic">No records found for selected dates</td></tr>
                                        )}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                );
            };

            const UsersView = () => {
                const [newUser, setNewUser] = useState({ name: '', username: '', password: '', role: 'Staff' });
                
                const addUser = () => {
                    if(!newUser.username || !newUser.password) return alert("Missing fields");
                    updateData('users', [...data.users, { ...newUser, id: Date.now() }]);
                    setNewUser({ name: '', username: '', password: '', role: 'Staff' });
                };

                return (
                    <div id="main-interface" className="flex gap-6 h-full">
                        <div className="flex-1 flex flex-col">
                             <h2 className="text-2xl font-bold mb-6">User Management</h2>
                             <div className="flex-1 glass-card rounded-2xl overflow-hidden">
                                <table className="w-full text-left text-sm">
                                    <thead className="bg-white/50"><tr><th className="p-4">Name</th><th className="p-4">Username</th><th className="p-4">Role</th><th className="p-4">Action</th></tr></thead>
                                    <tbody className="divide-y divide-white/20">
                                        {data.users.map(u => (
                                            <tr key={u.id}>
                                                <td className="p-4 font-bold">{u.name}</td>
                                                <td className="p-4 font-mono text-slate-500">{u.username}</td>
                                                <td className="p-4"><span className={`px-2 py-1 rounded-md text-xs font-bold ${u.role === 'Admin' ? 'bg-indigo-100 text-indigo-700' : 'bg-slate-100 text-slate-700'}`}>{u.role}</span></td>
                                                <td className="p-4">
                                                    {u.username !== 'admin' && <button className="text-red-500 hover:bg-red-50 p-2 rounded-lg" onClick={() => updateData('users', data.users.filter(x => x.id !== u.id))}><Icons.Trash size={16}/></button>}
                                                </td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                             </div>
                        </div>
                        <div className="w-80 glass-card rounded-2xl p-6 h-fit">
                            <h3 className="font-bold mb-4 text-lg">Create User</h3>
                            <Input label="Full Name" value={newUser.name} onChange={e => setNewUser({...newUser, name: e.target.value})} />
                            <Input label="Username" value={newUser.username} onChange={e => setNewUser({...newUser, username: e.target.value})} />
                            <Input label="Password" type="password" value={newUser.password} onChange={e => setNewUser({...newUser, password: e.target.value})} />
                            <div className="mb-4">
                                <label className="block text-xs font-bold text-slate-600 uppercase mb-1.5">Role</label>
                                <select className="w-full p-2.5 rounded-xl bg-white/50 border border-slate-200 outline-none" value={newUser.role} onChange={e => setNewUser({...newUser, role: e.target.value})}>
                                    <option value="Staff">Staff (POS Only)</option>
                                    <option value="Admin">Admin (Full Access)</option>
                                </select>
                            </div>
                            <Button className="w-full" onClick={addUser}><Icons.UserPlus size={18}/> Create User</Button>
                        </div>
                    </div>
                );
            };

            const InventoryView = () => {
                const [newItem, setNewItem] = useState({ name: '', price: '', stock: '' });
                const add = () => {
                    const p = { id: Date.now(), name: newItem.name, price: Number(newItem.price), stock: Number(newItem.stock) };
                    const log = { date: new Date().toISOString(), type: 'IN', prodName: p.name, qty: p.stock, reason: 'Initial Stock' };
                    
                    const newData = { ...data, products: [...data.products, p], stockLog: [...data.stockLog, log] };
                    setData(newData); syncDataToCloud(newData);
                    setNewItem({ name: '', price: '', stock: '' });
                };

                return (
                    <div id="main-interface" className="flex gap-6 h-full">
                        <div className="flex-1 flex flex-col">
                            <h2 className="text-2xl font-bold mb-6">Inventory</h2>
                            <div className="flex-1 glass-card rounded-2xl overflow-y-auto">
                                <table className="w-full text-left text-sm">
                                    <thead className="bg-white/50 sticky top-0 backdrop-blur-md"><tr><th className="p-4">Item</th><th className="p-4">Price</th><th className="p-4">Stock</th><th className="p-4">Delete</th></tr></thead>
                                    <tbody className="divide-y divide-white/20">
                                        {data.products.map(p => (
                                            <tr key={p.id} className="hover:bg-white/30">
                                                <td className="p-4 font-bold">{p.name}</td>
                                                <td className="p-4">₹{p.price}</td>
                                                <td className="p-4">{p.stock}</td>
                                                <td className="p-4"><button className="text-red-400 hover:text-red-600" onClick={() => updateData('products', data.products.filter(x => x.id !== p.id))}><Icons.Trash size={16}/></button></td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div className="w-80 glass-card rounded-2xl p-6 h-fit">
                             <h3 className="font-bold mb-4">Add Product</h3>
                             <Input label="Name" value={newItem.name} onChange={e => setNewItem({...newItem, name: e.target.value})} />
                             <Input label="Price (₹)" type="number" value={newItem.price} onChange={e => setNewItem({...newItem, price: e.target.value})} />
                             <Input label="Initial Stock" type="number" value={newItem.stock} onChange={e => setNewItem({...newItem, stock: e.target.value})} />
                             <Button className="w-full" onClick={add}>Add Item</Button>
                        </div>
                    </div>
                );
            };

            const SettingsView = () => {
                const [token, setToken] = useState(ghConfig.token);
                const [gist, setGist] = useState(ghConfig.gistId);
                const [profile, setProfile] = useState(data.profile);

                const createDB = async () => {
                    const g = await createGist(token, "POS DB", data);
                    setGist(g.id); setGhConfig({ token, gistId: g.id });
                    alert("Database Created!");
                };

                const saveProfile = () => {
                    updateData('profile', profile);
                    alert("Profile Saved!");
                };

                return (
                    <div id="main-interface" className="max-w-4xl mx-auto space-y-6 overflow-y-auto h-full pb-10">
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                            {/* Connection Card */}
                            <Card>
                                <h2 className="text-xl font-bold mb-4 flex items-center gap-2"><Icons.Github/> Cloud Database</h2>
                                <p className="text-sm text-slate-500 mb-4">Connect to GitHub Gists to save data online for free.</p>
                                <Input label="GitHub Token" type="password" value={token} onChange={e => setToken(e.target.value)} />
                                <div className="flex gap-4 items-end mb-4">
                                    <div className="flex-1"><Input label="Database ID" value={gist} onChange={e => setGist(e.target.value)} /></div>
                                    <div className="mb-4"><Button onClick={createDB} disabled={!token}>Create New</Button></div>
                                </div>
                                <div className="flex gap-4">
                                    <Button className="flex-1" onClick={() => setGhConfig({token, gistId: gist})}>Save Config</Button>
                                    <Button variant="secondary" onClick={syncDataFromCloud} disabled={!isOnline}>Force Load</Button>
                                </div>
                            </Card>

                            {/* Business Profile Card */}
                            <Card>
                                <h2 className="text-xl font-bold mb-4 flex items-center gap-2"><Icons.Settings/> Business Profile</h2>
                                <p className="text-sm text-slate-500 mb-4">Details for Receipts & Reports.</p>
                                <div className="grid grid-cols-2 gap-4">
                                    <div className="col-span-2"><Input label="Business Name" value={profile.name} onChange={e => setProfile({...profile, name: e.target.value})} /></div>
                                    <Input label="Business Type" value={profile.type} onChange={e => setProfile({...profile, type: e.target.value})} />
                                    <Input label="Contact Number" value={profile.phone} onChange={e => setProfile({...profile, phone: e.target.value})} />
                                    <div className="col-span-2"><Input label="Address" value={profile.address} onChange={e => setProfile({...profile, address: e.target.value})} /></div>
                                    <Input label="Location/City" value={profile.location} onChange={e => setProfile({...profile, location: e.target.value})} />
                                    <Input label="GST / Tax ID" value={profile.gst} onChange={e => setProfile({...profile, gst: e.target.value})} />
                                    <div className="col-span-2"><Input label="Logo URL (Optional)" value={profile.logo} onChange={e => setProfile({...profile, logo: e.target.value})} placeholder="https://..." /></div>
                                </div>
                                <Button className="w-full mt-2" onClick={saveProfile}>Save Business Profile</Button>
                            </Card>
                        </div>
                    </div>
                );
            };

            const Receipt = () => {
                if(!receiptTx) return null;
                return (
                    <Modal isOpen={true} onClose={() => setReceiptTx(null)} title="Receipt Generated">
                        <div id="receipt-printable" className="bg-white p-4 font-mono text-sm border rounded shadow-sm text-center relative">
                            {/* Header for Print (Hidden visually in 'Success' mode if we want, but let's show it for clarity) */}
                            <div className="mb-4">
                                <h2 className="font-bold text-xl uppercase">{data.profile.name}</h2>
                                <p className="text-xs text-slate-500">{data.profile.address}</p>
                                <p className="text-xs text-slate-500">{data.profile.phone}</p>
                            </div>
                            
                            <div className="border-b border-dashed border-slate-300 my-2"></div>
                            
                            <div className="text-left text-xs mb-4 space-y-1">
                                <div className="flex justify-between"><span>Date:</span> <span>{new Date(receiptTx.date).toLocaleDateString()}</span></div>
                                <div className="flex justify-between"><span>Time:</span> <span>{new Date(receiptTx.date).toLocaleTimeString()}</span></div>
                                <div className="flex justify-between"><span>TxID:</span> <span>{receiptTx.id.slice(-6)}</span></div>
                                <div className="flex justify-between"><span>Cashier:</span> <span>{receiptTx.cashier}</span></div>
                            </div>

                            <div className="border-b border-dashed border-slate-300 my-2"></div>

                            <div className="text-left mb-4">
                                <div className="flex justify-between font-bold text-xs mb-2">
                                    <span>Item</span>
                                    <span>Amt</span>
                                </div>
                                {receiptTx.items.map((item, i) => (
                                    <div key={i} className="flex justify-between text-xs mb-1">
                                        <span>{item.quantity} x {item.name}</span>
                                        <span>{(item.price * item.quantity).toFixed(2)}</span>
                                    </div>
                                ))}
                            </div>

                            <div className="border-t border-dashed border-slate-300 pt-2">
                                <div className="flex justify-between font-bold text-lg">
                                    <span>TOTAL</span>
                                    <span>₹{receiptTx.total.toFixed(2)}</span>
                                </div>
                            </div>
                            
                            <div className="mt-6 text-center text-xs text-slate-400">
                                Thank you for your business!
                            </div>
                        </div>
                        
                        {/* Actions - Hidden when printing */}
                        <div className="flex flex-col gap-3 mt-6 no-print">
                            <div className="flex gap-3">
                                <Button className="flex-1" onClick={() => window.print()}>
                                    <Icons.Printer size={18}/> Print Now
                                </Button>
                                <Button className="flex-1 bg-purple-600 hover:bg-purple-700 text-white" onClick={() => generateReceiptPDF(receiptTx, data.profile)}>
                                    <Icons.Download size={18}/> PDF
                                </Button>
                            </div>
                            <Button variant="secondary" onClick={() => setReceiptTx(null)}>Close Window</Button>
                        </div>
                    </Modal>
                );
            };

            if(view === 'login') return <LoginView />;

            return (
                <div className="flex h-screen overflow-hidden text-sm">
                    {/* Sidebar */}
                    <div id="main-interface" className="w-64 glass-dark text-white flex flex-col z-20 shadow-2xl">
                        <div className="p-6">
                            <h1 className="text-xl font-bold flex items-center gap-2"><span className="bg-indigo-500 p-1 rounded">GL</span> POS</h1>
                            <div className={`mt-4 text-xs px-3 py-1.5 rounded-lg flex items-center gap-2 ${isOnline ? 'bg-emerald-500/20 text-emerald-300 border border-emerald-500/30' : 'bg-white/10 text-slate-400'}`}>
                                {isOnline ? <Icons.CloudCheck size={12}/> : <Icons.CloudOff size={12}/>}
                                {isOnline ? 'Cloud Synced' : 'Local Mode'}
                                {isSyncing && <span className="animate-pulse ml-auto">●</span>}
                            </div>
                        </div>
                        
                        <div className="flex-1 px-3 space-y-1">
                            <button onClick={() => setView('pos')} className={`w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all ${view === 'pos' ? 'bg-indigo-600 shadow-lg shadow-indigo-900/50' : 'hover:bg-white/10 text-slate-300'}`}>
                                <Icons.Cart/> POS
                            </button>
                            
                            {/* Role Based Access: Only Admin sees these */}
                            {activeUser?.role === 'Admin' && (
                                <>
                                    <button onClick={() => setView('inventory')} className={`w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all ${view === 'inventory' ? 'bg-indigo-600 shadow-lg shadow-indigo-900/50' : 'hover:bg-white/10 text-slate-300'}`}>
                                        <Icons.Box/> Inventory
                                    </button>
                                    <button onClick={() => setView('reports')} className={`w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all ${view === 'reports' ? 'bg-indigo-600 shadow-lg shadow-indigo-900/50' : 'hover:bg-white/10 text-slate-300'}`}>
                                        <Icons.Report/> Reports
                                    </button>
                                    <button onClick={() => setView('users')} className={`w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all ${view === 'users' ? 'bg-indigo-600 shadow-lg shadow-indigo-900/50' : 'hover:bg-white/10 text-slate-300'}`}>
                                        <Icons.Users/> Users
                                    </button>
                                    <button onClick={() => setView('settings')} className={`w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all ${view === 'settings' ? 'bg-indigo-600 shadow-lg shadow-indigo-900/50' : 'hover:bg-white/10 text-slate-300'}`}>
                                        <Icons.Settings/> Settings
                                    </button>
                                </>
                            )}
                        </div>

                        <div className="p-4 border-t border-white/10 bg-black/20">
                            <div className="flex items-center gap-3 mb-3">
                                <div className="w-8 h-8 rounded-full bg-gradient-to-tr from-indigo-500 to-purple-500 flex items-center justify-center font-bold text-xs">
                                    {activeUser?.username[0].toUpperCase()}
                                </div>
                                <div>
                                    <div className="font-bold">{activeUser?.name}</div>
                                    <div className="text-xs text-slate-400">{activeUser?.role}</div>
                                </div>
                            </div>
                            <button onClick={() => setView('login')} className="flex items-center gap-2 text-red-300 hover:text-white text-xs"><Icons.Logout size={14}/> Sign Out</button>
                        </div>
                    </div>

                    {/* Main Content */}
                    <div id="main-interface" className="flex-1 p-6 overflow-hidden relative">
                        {/* Background Blobs for Glass Effect */}
                        <div className="absolute top-0 left-0 w-96 h-96 bg-purple-500 rounded-full mix-blend-multiply filter blur-3xl opacity-20 -z-10 animate-blob"></div>
                        <div className="absolute top-0 right-0 w-96 h-96 bg-indigo-500 rounded-full mix-blend-multiply filter blur-3xl opacity-20 -z-10 animate-blob animation-delay-2000"></div>
                        <div className="absolute -bottom-32 left-20 w-96 h-96 bg-pink-500 rounded-full mix-blend-multiply filter blur-3xl opacity-20 -z-10 animate-blob animation-delay-4000"></div>

                        {view === 'pos' && <POSView />}
                        {view === 'inventory' && <InventoryView />}
                        {view === 'reports' && <ReportsView />}
                        {view === 'users' && <UsersView />}
                        {view === 'settings' && <SettingsView />}
                    </div>
                    
                    <Receipt />
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
